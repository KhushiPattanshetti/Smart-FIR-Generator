{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <h2 class="mb-4">Audio Transcription for FIR: {{ fir.fir_number }}</h2>
  
  <div class="card">
    <div class="card-body">
      <form id="audioTranscriptionForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
          <label for="audio_file">Upload Audio File</label>
          <input type="file" class="form-control-file" id="audio_file" name="audio_file" accept="audio/*" required>
          <small class="form-text text-muted">Supported formats: {{ supported_audio_types|join:", " }}</small>
        </div>
        <div class="form-group">
          <label for="language">Language</label>
          <select class="form-control" id="language" name="language" required>
            <option value="en-US">English</option>
            <option value="hi-IN">Hindi</option>
            <option value="mr-IN">Marathi</option>
            <option value="ta-IN">Tamil</option>
            <option value="te-IN">Telugu</option>
            <option value="kn-IN">Kannada</option>
            <option value="ml-IN">Malayalam</option>
            <option value="bn-IN">Bengali</option>
            <option value="gu-IN">Gujarati</option>
            <option value="pa-IN">Punjabi</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Transcribe Audio</button>
        <a href="{% url 'officer_fir_detail' pk=fir.pk %}" class="btn btn-secondary">Cancel</a>
      </form>
      
      <div id="transcriptionResult" class="mt-4" style="display: none;">
        <h5>Transcription Result:</h5>
        <div class="card">
          <div class="card-body">
            <p id="originalText"></p>
            <hr>
            <small>English Translation: <span id="translatedText"></span></small>
          </div>
        </div>
        <button id="saveTranscriptionBtn" class="btn btn-success mt-3">Save to Case</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('audioTranscriptionForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  fetch("{% url 'transcribe_audio' fir_pk=fir.pk %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      document.getElementById('originalText').textContent = data.transcription;
      document.getElementById('translatedText').textContent = data.translation;
      document.getElementById('transcriptionResult').style.display = 'block';
    } else {
      alert('Error: ' + data.error);
    }
  });
});

document.getElementById('saveTranscriptionBtn').addEventListener('click', function() {
  const transcription = document.getElementById('originalText').textContent;
  const translation = document.getElementById('translatedText').textContent;
  
  fetch("{% url 'officer_fir_detail' pk=fir.pk %}", {
    method: 'POST',
    body: JSON.stringify({
      'note': 'Audio transcription: ' + transcription,
      'translated_text': translation
    }),
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (response.ok) {
      window.location.href = "{% url 'officer_fir_detail' pk=fir.pk %}";
    }
  });
});
</script>
{% endblock %}