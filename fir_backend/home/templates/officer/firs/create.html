{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0" style="color: #0a1f44; font-weight: 600;">
        <i class="bi bi-scale me-2" style="color: #5e0b15;"></i>Register New FIR
      </h2>
      <p class="mb-0 text-muted">File a First Information Report with the Indian Police</p>
    </div>
    <div class="badge" style="background-color: #5e0b15; color: ivory; font-weight: 500;">
      <i class="bi bi-shield-lock me-1"></i> Secure Submission
    </div>
  </div>
  
  <div class="card border-0 shadow-sm" style="border-radius: 12px; background-color: #f8f7f3;">
    <div class="card-header py-3" style="background: linear-gradient(135deg, #0a1f44 0%, #5e0b15 100%); color: ivory; border-radius: 12px 12px 0 0 !important;">
      <div class="d-flex align-items-center">
        <i class="bi bi-file-earmark-text me-2 fs-4"></i>
        <h5 class="mb-0" style="font-weight: 500;">Complaint Details</h5>
      </div>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle-fill me-2"></i> Please provide incident details in <strong>at least one</strong> format (text, image, or audio)
        </div>
        
        <h6 class="mt-4 mb-3 fw-bold" style="color: #5e0b15;">
          <i class="bi bi-person-badge me-2"></i>Complainant Information
        </h6>
        
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="complainant_name" class="form-label fw-medium" style="color: #0a1f44;">
              Full Name <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="complainant_name" name="complainant_name" placeholder="Enter full name as per ID proof" required>
            </div>
            <div class="form-text">Please enter your full legal name</div>
          </div>
          <div class="col-md-6">
            <label for="complainant_contact" class="form-label fw-medium" style="color: #0a1f44;">
              Contact Number <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-telephone"></i></span>
              <input type="text" class="form-control" id="complainant_contact" name="complainant_contact" placeholder="Enter 10-digit mobile number" required>
            </div>
          </div>
        </div>
        
        <h6 class="mt-5 mb-3 fw-bold" style="color: #5e0b15;">
          <i class="bi bi-calendar-event me-2"></i>Incident Details
        </h6>
        
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="incident_date" class="form-label fw-medium" style="color: #0a1f44;">
              Date & Time <span class="text-danger">*</span>
            </label>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                  <input type="date" class="form-control" id="incident_date" name="incident_date" required>
                </div>
              </div>
            </div>
            <div class="form-text">When did the incident occur?</div>
          </div>
          <div class="col-md-6">
            <label for="incident_location" class="form-label fw-medium" style="color: #0a1f44;">
              Location <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
              <input type="text" class="form-control" id="incident_location" name="incident_location" placeholder="Enter precise location with landmark" required>
            </div>
          </div>
        </div>
        
        <!-- Description Options Tabs -->
        <div class="mb-4">
          <ul class="nav nav-tabs" id="descriptionTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-tab-pane" type="button" role="tab">
                <i class="bi bi-text-paragraph me-1"></i> Text Description
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-tab-pane" type="button" role="tab">
                <i class="bi bi-image me-1"></i> Upload Image
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio-tab-pane" type="button" role="tab">
                <i class="bi bi-mic me-1"></i> Record Audio
              </button>
            </li>
          </ul>
          
          <div class="tab-content p-3 border border-top-0 rounded-bottom" style="background-color: white;">
            <!-- Text Description Tab -->
            <div class="tab-pane fade show active" id="text-tab-pane" role="tabpanel" aria-labelledby="text-tab">
              <label for="incident_description" class="form-label fw-medium" style="color: #0a1f44;">
                Describe the incident in detail
              </label>
              <textarea class="form-control" id="incident_description" name="incident_description" rows="6" placeholder="Provide detailed description of what happened"></textarea>
              <div class="form-text mt-2">
                <i class="bi bi-lightbulb"></i> Tip: Be factual and chronological. Include all relevant details.
              </div>
            </div>
            
            <!-- Image Upload Tab -->
            <div class="tab-pane fade" id="image-tab-pane" role="tabpanel" aria-labelledby="image-tab">
              <label class="form-label fw-medium" style="color: #0a1f44;">
                Upload an image of the incident or related evidence
              </label>
              <div class="card border-dashed p-3" style="border: 2px dashed #ced4da; border-radius: 8px;">
                <div class="d-flex flex-column align-items-center">
                  <div id="imagePreviewContainer" class="mb-3 text-center" style="display: none;">
                    <img id="imagePreview" src="#" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearImage()">
                      <i class="bi bi-trash"></i> Remove Image
                    </button>
                  </div>
                  <div id="imageUploadArea" class="text-center">
                    <i class="bi bi-image fs-1" style="color: #5e0b15;"></i>
                    <p class="mt-2 mb-1">Drag & drop image here or click to browse</p>
                    <p class="text-muted small mb-3">Supports JPG, PNG (Max 5MB)</p>
                    <input type="file" class="d-none" id="incident_image" name="incident_image" accept="image/*" capture="camera">
                    <button type="button" class="btn btn-sm me-2" style="background-color: #0a1f44; color: ivory;" onclick="document.getElementById('incident_image').click()">
                      <i class="bi bi-upload"></i> Upload Image
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="captureImage()">
                      <i class="bi bi-camera"></i> Take Photo
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Audio Upload Tab -->
            <div class="tab-pane fade" id="audio-tab-pane" role="tabpanel" aria-labelledby="audio-tab">
              <label class="form-label fw-medium" style="color: #0a1f44;">
                Record or upload audio description of the incident
              </label>
              <div class="card border-dashed p-3" style="border: 2px dashed #ced4da; border-radius: 8px;">
                <div class="d-flex flex-column align-items-center">
                  <div id="audioPreviewContainer" class="mb-3 text-center" style="display: none;">
                    <audio id="audioPreview" controls class="w-100"></audio>
                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearAudio()">
                      <i class="bi bi-trash"></i> Remove Audio
                    </button>
                  </div>
                  <div id="audioUploadArea" class="text-center">
                    <i class="bi bi-mic fs-1" style="color: #5e0b15;"></i>
                    <p class="mt-2 mb-1">Record audio or upload existing recording</p>
                    <p class="text-muted small mb-3">Supports MP3, WAV (Max 10MB)</p>
                    <div class="d-flex justify-content-center gap-2">
                      <input type="file" class="d-none" id="incident_audio" name="incident_audio" accept="audio/*">
                      <button type="button" class="btn btn-sm" style="background-color: #0a1f44; color: ivory;" onclick="document.getElementById('incident_audio').click()">
                        <i class="bi bi-upload"></i> Upload Audio
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" id="recordButton">
                        <i class="bi bi-mic"></i> Start Recording
                      </button>
                      <button type="button" class="btn btn-sm btn-danger" id="stopButton" style="display: none;">
                        <i class="bi bi-stop-circle"></i> Stop
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="declaration" required>
            <label class="form-check-label" for="declaration">
              I declare that the information provided is true to the best of my knowledge and belief. I understand that false reporting is punishable under <strong>Section 177, 182 IPC</strong>.
            </label>
          </div>
        </div>
      
        <div class="d-flex justify-content-between mt-5">
          <a href="{% url 'officer_fir_list' %}" class="btn btn-outline-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Cases
          </a>
          <div>
            <button type="reset" class="btn btn-outline-danger me-2 px-4" onclick="resetForm()">
              <i class="bi bi-eraser me-1"></i> Clear Form
            </button>
            <button type="submit" class="btn px-4" style="background: linear-gradient(135deg, #0a1f44 0%, #5e0b15 100%); color: ivory;" id="submitBtn">
              <i class="bi bi-file-earmark-check me-1"></i> Submit FIR
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <div class="mt-4 text-center" style="color: #6c757d; font-size: 0.9rem;">
    <i class="bi bi-shield-check me-1"></i> Your information is secured under the Digital India Act
  </div>
</div>

<style>
  body {
    background-color: #f8f7f3;
  }
  
  .card {
    border: 1px solid rgba(10, 31, 68, 0.1);
    box-shadow: 0 4px 12px rgba(10, 31, 68, 0.08);
  }
  
  .form-control, .form-select, .input-group-text {
    border-color: #ced4da;
    transition: all 0.3s;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #5e0b15;
    box-shadow: 0 0 0 0.25rem rgba(94, 11, 21, 0.1);
  }
  
  .input-group-text {
    background-color: #f8f9fa;
    color: #5e0b15;
  }
  
  textarea.form-control {
    min-height: 150px;
    background-color: #fff;
  }
  
  .btn-outline-secondary {
    border-color: #0a1f44;
    color: #0a1f44;
  }
  
  .btn-outline-secondary:hover {
    background-color: #0a1f44;
    color: white;
  }
  
  .form-check-input:checked {
    background-color: #5e0b15;
    border-color: #5e0b15;
  }
  
  .alert-info {
    background-color: #e9f5ff;
    border-color: #b8d9f8;
    color: #0a1f44;
  }
  
  .border-dashed {
    border-style: dashed !important;
  }
  
  .nav-tabs .nav-link {
    color: #0a1f44;
    border: 1px solid transparent;
    border-bottom: 3px solid transparent;
  }
  
  .nav-tabs .nav-link:hover {
    border-color: transparent;
    color: #5e0b15;
  }
  
  .nav-tabs .nav-link.active {
    color: #5e0b15;
    border-bottom: 3px solid #5e0b15;
    background-color: transparent;
  }
  
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
    }
    
    .d-flex.justify-content-between > div {
      width: 100%;
    }
    
    .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .nav-tabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .nav-tabs .nav-item {
      display: inline-block;
      float: none;
    }
  }
</style>

<script>
  // Simple client-side validation for mobile number
  document.getElementById('complainant_contact').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 10);
  });
  
  // Image handling
  const imageInput = document.getElementById('incident_image');
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewContainer = document.getElementById('imagePreviewContainer');
  const imageUploadArea = document.getElementById('imageUploadArea');
  
  imageInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreviewContainer.style.display = 'block';
        imageUploadArea.style.display = 'none';
      }
      reader.readAsDataURL(this.files[0]);
    }
  });
  
  function clearImage() {
    imageInput.value = '';
    imagePreview.src = '#';
    imagePreviewContainer.style.display = 'none';
    imageUploadArea.style.display = 'block';
  }
  
  function captureImage() {
    // This would use the device camera (implementation depends on specific requirements)
    alert("Camera functionality would be implemented here for actual devices");
    // For demo purposes, we'll just trigger the file input
    imageInput.click();
  }
  
  // Audio handling
  const audioInput = document.getElementById('incident_audio');
  const audioPreview = document.getElementById('audioPreview');
  const audioPreviewContainer = document.getElementById('audioPreviewContainer');
  const audioUploadArea = document.getElementById('audioUploadArea');
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  let mediaRecorder;
  let audioChunks = [];
  
  audioInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      audioPreview.src = URL.createObjectURL(this.files[0]);
      audioPreviewContainer.style.display = 'block';
      audioUploadArea.style.display = 'none';
    }
  });
  
  function clearAudio() {
    audioInput.value = '';
    audioPreview.src = '';
    audioPreviewContainer.style.display = 'none';
    audioUploadArea.style.display = 'block';
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
  }
  
  // Audio recording functionality
  recordButton.addEventListener('click', async function() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      
      mediaRecorder.ondataavailable = function(e) {
        audioChunks.push(e.data);
      };
      
      mediaRecorder.onstop = function() {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPreview.src = audioUrl;
        
        // Create a file from the blob and assign it to the input
        const audioFile = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(audioFile);
        audioInput.files = dataTransfer.files;
        
        audioPreviewContainer.style.display = 'block';
        audioUploadArea.style.display = 'none';
      };
      
      mediaRecorder.start();
      recordButton.style.display = 'none';
      stopButton.style.display = 'block';
    } catch (err) {
      console.error('Error accessing microphone:', err);
      alert('Could not access microphone. Please check permissions.');
    }
  });
  
  stopButton.addEventListener('click', function() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      stopButton.style.display = 'none';
      recordButton.style.display = 'block';
    }
  });
  
  // Form reset handler
  function resetForm() {
    clearImage();
    clearAudio();
    document.getElementById('incident_description').value = '';
    document.getElementById('text-tab').click();
  }
  
  // Form validation
  document.getElementById('submitBtn').addEventListener('click', function(e) {
    const textDesc = document.getElementById('incident_description').value.trim();
    const hasImage = imageInput.files.length > 0;
    const hasAudio = audioInput.files.length > 0;
    
    if (!textDesc && !hasImage && !hasAudio) {
      e.preventDefault();
      alert('Please provide incident details in at least one format (text, image, or audio)');
      return false;
    }
    
    return true;
  });
  
  // Initialize Bootstrap tabs if not already initialized
  if (typeof bootstrap !== 'undefined') {
    const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabEls.forEach(tabEl => {
      new bootstrap.Tab(tabEl);
    });
  }
</script>
{% endblock %}